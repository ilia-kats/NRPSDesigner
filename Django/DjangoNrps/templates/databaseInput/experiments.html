{% extends "base.html" %}

{% block css-include %}

{% endblock %}

{% block js-include %}
{% load staticfiles %}
<script type="text/javascript" src="{% static "js/BioJS/Biojs.js" %}"></script>
<script type="text/javascript" src="{% static "js/BioJS/Biojs.Sequence.js" %}"></script>
<script type="text/javascript" src="{% static "js/BioJS/Biojs.Tooltip.js" %}"></script>

<script type="text/javascript" src="{% static "js/jquery.scrollTo.min.js" %}"></script>
<script type="text/javascript" src="{% static "js/biojs_helper.js" %}"></script>
{% endblock %}


{% block content %}


{% if success %}
<div class="alert alert-success">
  <button type="button" class="close" data-dismiss="alert">&times;</button>
The experimentally described  domain interaction has been successfully entered into the database!

</div>

{% else %}
<div class="alert alert-info">
  <button type="button" class="close" data-dismiss="alert">&times;</button>
Report a successful assembly of two NRPS domains.
</div>

{% endif %}

<div id="errors">
</div>

<form id="domainTupleForm">
<div class="row">
<div class="span5">

      <div class="fieldWrapper">
                  {{ form.description.errors }}
                  <label>  Description </label>
                  {{ form.description }}
                </div>
                </div>

<div class="span5">
 {{ linkoutSet.management_form }}
  <div>
<label >References:</label>
  {% for linkout in linkoutSet %}

<div class="linkoutSet">
  {{ linkout.linkoutType }}
  {{ linkout.identifier }}
</div>

{% endfor %}
</div>
</div>
</div>


<div class="row">
<div class="span5">
Left domain Filters:
<input type="hidden" style="width:380px;" id="originsLeft"/>
<input type="hidden" style="width:380px;" id="domainTypesLeft"/>
<br/>
Left domain:
<input type="hidden" id="domainsLeft" />


                <div class="fieldWrapper">
                  {{ form.prev_position.errors }}
                  Left boundary:
                  {{ form.prev_position }}
                </div>

</div>
<div class="span9">
<div id="leftBioJsSequenceDiv" style="height:180px; overflow-y:auto"></div>

</div>
</div>

<div class="row">
<div class="span5">
Right domain Filters:
<input type="hidden" style="width:380px;" id="originsRight"/>
<input type="hidden" style="width:380px;" id="domainTypesRight"/>
<br/>
Right domain:
<input type="hidden" id="domainsRight" />


                <div class="fieldWrapper">
                  {{ form.next_position.errors }}
                  Right boundary:
                  {{ form.next_position }}
                </div>



</div>

<div class="span9">
     <div id="rightBioJsSequenceDiv" style="height:180px; overflow-y:auto" ></div>

</div>
</div>

</form>

  <button class="btn btn-large" id="submitButton" type="button">Submit</button>


{% endblock %}


{% block js %}
<script>
// even though ids for left and right domain are not generated by django form
// make sure to submit it via post in order to be able to use form functionality
function emulateDjangoForm() {
    data = jQuery("#domainTupleForm").serializeArray()
    data.push({name:"domainTuple-prev_domain", value:jQuery("#domainsLeft").val()})
    data.push({name:"domainTuple-next_domain", value:jQuery("#domainsRight").val()})
    return jQuery.param(data)

}

jQuery(document).ready(function() {

jQuery("#originsLeft").select2({
    placeholder: "Filter by Origin",
    ajax: {
        url: "{% url 'getOrigins' %}",
        dataType: 'json',
        results: jsonResponseResult
    },
    escapeMarkup: function (m) { return m; } // we do not want to escape markup since we are displaying html in results
});

jQuery("#domainTypesLeft").select2({
    placeholder: "Filter by domain type",
    ajax: {
        url: "{% url 'getDomainTypes' %}",
        dataType: 'json',
        results: jsonResponseResult
    },
    escapeMarkup: function (m) { return m; } // we do not want to escape markup since we are displaying html in results
});

jQuery("#domainsLeft").select2({
    placeholder: "Search for domain",
    ajax: {
        url: "{% url 'getDomains' %}",
        dataType: 'json',
        data: function (term, page) { // page is the one-based page number tracked by Select2
            return {
                originId: jQuery("#originsLeft").val(),
                typeId: jQuery("#domainTypesLeft").val()
            };
        },
        results: jsonResponseResult
    },
    dropdownCssClass: "bigdrop", // apply css that makes the dropdown taller
    escapeMarkup: function (m) { return m; } // we do not want to escape markup since we are displaying html in results
});


jQuery("#originsRight").select2({
    placeholder: "Filter by Origin",
    ajax: {
        url: "{% url 'getOrigins' %}",
        dataType: 'json',
        results: jsonResponseResult
    },
    escapeMarkup: function (m) { return m; } // we do not want to escape markup since we are displaying html in results
});

jQuery("#domainTypesRight").select2({
    placeholder: "Filter by domain type",
    ajax: {
        url: "{% url 'getDomainTypes' %}",
        dataType: 'json',
        results: jsonResponseResult
    },
    escapeMarkup: function (m) { return m; } // we do not want to escape markup since we are displaying html in results
});

jQuery("#domainsRight").select2({
    placeholder: "Search for domain",
    ajax: {
        url: "{% url 'getDomains' %}",
        dataType: 'json',
        data: function (term, page) { // page is the one-based page number tracked by Select2
            return {
                originId: jQuery("#originsRight").val(),
                typeId: jQuery("#domainTypesRight").val()
            };
        },
        results: jsonResponseResult
    },
    dropdownCssClass: "bigdrop", // apply css that makes the dropdown taller
    escapeMarkup: function (m) { return m; } // we do not want to escape markup since we are displaying html in results
});

// to be used on callbacks by select2.js after ajax response
function jsonResponseResult(data, page) {
	return { results: data[1]};
}

jQuery(".linkoutSet").formset({addText:'<i class="icon-plus"></i>',
        deleteText:'<i class="icon-remove"></i>',
        prefix: '{{ linkoutSet.prefix }}',
      });

jQuery("#submitButton").click( function() {
    jQuery.post( "{% url 'experiments' %}", emulateDjangoForm(), function(data){
        if (data[0] == -1){
            jQuery("#errors").html(data[1].html)
        } else{
            window.location.replace(data[1].url)
        }
    });

});


leftSequence = new BiojsSequenceHelper({target: "leftBioJsSequenceDiv", url: "{% url 'getBioJsSequence' %}", onSelectionChange: function( objEvent ) {jQuery("#id_domainTuple-prev_position").val(objEvent.end)}});
jQuery("#domainsLeft").change(function(e){
    jQuery("#id_domainTuple-prev_position").val("")
    leftSequence.showBioJsSequence({domainId:e.val});
});

rightSequence = new BiojsSequenceHelper({target: "rightBioJsSequenceDiv", url: "{% url 'getBioJsSequence' %}", onSelectionChange: function( objEvent ) {jQuery("#id_domainTuple-next_position").val(objEvent.end)}});
jQuery("#domainsRight").change(function(e){
    jQuery("#id_domainTuple-next_position").val("")
    rightSequence.showBioJsSequence({domainId:e.val});
});
});

</script>

{% endblock %}
